# Kernel-4.12 メモ
# Linux-4.12-rc1 でキーボードが効かなくなった話

kernel のログに i8042 が CRT をうんぬんと言うエラーが出たんだけど bios で legacy usb
support を auto にしたら、キーが生きた。

ここで聴いてみてた。
https://is.gd/3BJAKR

# geekbench4 でさぼりがち

multi-core で 3200 とか出ることがある。どうも geekbench を負荷の高い作業と認識してないよう
で、さぼるらしい。LLVM で 8000 越えたかと思うと、もう一回やると 4000 とか非常にむらが大き
い。とりあえず top -d1 とかして、軽く負荷掛けたほうが安定する。ただそれでも気持 4.7.2 のス
コアより悪い。

# amdgpu X 動かない

xorg のログには何もエラーが出てないが、ただの黒い画面しか映らない。どうも 4.11 のころより
後退しているようだ。


# 4.12-rc2

# CPU Freq Governor の Ondemand がサボるようになってしまった

なんか GeekBench4 で特にマルチスレッドでスコアが下がる。4.7 では 3700 以上出るのが、裏で
top とか動かしてサボらないようにしても 3600 とかしかでない。下手すると 3300 とかになる。と
いうのが rc1 だった。

そこで久々に ガバナーを弄ってみる。

まず performance にしてみた。performance だと A8-7410 は 2200MHz で貼りつく。ただ
lm_sensors で見ている限り、無負荷で電圧が下がり、爆高温になることはなさそうだ。で
Geekbench4 のマルチスレッドは 3676。微妙に低い。シングルは 1506 でまあこれまで通り。

次い Ondemand。裏で top -d 0.001 とかはしない。シングルは 1488 でマルチが 3630 でどちらも
ちょっと低い（シングルは 4.7 だと 1500-1520 程度)

up_threshhold を初期値の 95 から 40 にしてみると、1505 の 3697 となった。3700 越えられなか
ったけど、悪くない。

sampling_down_factor を 50000 にしたら 1495 の 3424。うーん、こっち弄るのは無しかな。

up_threshhold を 5 にしてみたら 1486 の 3701. シングルは微妙だけど、マルチは性能出た。ただ
これを恒久的に変更すると 4.7 でブートしたときにも影響出ちゃうんだよな (udev ルールの書き方
知らんだけかもしれんけど)

それでも Unigine Heaven のスコアが伸びてくれれば、GeekBench 4 に目を瞑って 4.12 に移行する
んだけど radeon で 381 とこれまでと変化がなく、amdgpu は X が起動しない。

あと電池が少なくなってるのかカーネル側が変わっているのか、やたらとマウスが動かなくなる。が
ちゃがちゃすると、復帰するので USB の電源が切られているようなんだが、電池残量確認できるツ
ールも入れてないのでなんとも言えない。

今回、-march=native を付けて gcc-7-20170511 を使ったのが問題かもしれない。gcc-6.2 で初期値
の -O2 のみでやるところからスタートしてみる。Unigine Heaven は radeon で 382 点、GeekBench4 は 1504
の 3265, 相変らず multi core でサボるけど、カーネルに -march 付けようがどうしようが、シス
テムで見たときのパフォーマンスを体感できるような変化はないんだね。では amdgpu はどうかな？

amdgpu に切り替えた初回は キーボードが効かない。リブートすると効く。最初の legacy usb は無
罪だったかもしれない。X は我慢してしばらく待つと起動した。もしかすると gcc-7 の時も気長に
待てば起動したのかもしれない。でも gxlgeras が 3500 前後と 1 割引き, Unigine Heaven も全体
的に 1FPS くらい radeon より遅い

とりあえず 4.7 を使い続けて Mesa が出るたびに試すようにしてみよう。あと -O2 のみで十分みた
いだから余計なことはしないでおこう。

<!-- vim: set tw=90 filetype=markdown : -->
